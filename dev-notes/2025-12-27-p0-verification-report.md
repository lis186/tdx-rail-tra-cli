# P0 å¹¶å‘é—®é¢˜éªŒè¯æŠ¥å‘Š

## æ‰§è¡Œæ—¥æœŸ
2025-12-27

## æµ‹è¯•æ–¹æ³•
**èµ„æ·±å·¥ç¨‹å¸ˆéªŒè¯æ³•**ï¼šä½¿ç”¨çœŸå®çš„å¼‚æ­¥å¹¶å‘æµ‹è¯•ï¼ˆé fake timersï¼‰ï¼Œæš´éœ²å®é™…é—®é¢˜

## éªŒè¯ç»“æœ

### âŒ é—®é¢˜ 1ï¼šRateLimiter å¹¶å‘å¤±è´¥ç‡ 88.8%

**æµ‹è¯•åœºæ™¯**
```
- åŒæ—¶å‘èµ·ï¼š1000 ä¸ª acquire() è¯·æ±‚
- å¯ç”¨ tokenï¼šä»… 50 ä¸ª
- é‡è¯•æœºåˆ¶ï¼šenabled (maxRetries=100)
```

**é¢„æœŸç»“æœ**
```
æˆåŠŸç‡ï¼š100% (æ‰€æœ‰è¯·æ±‚é€šè¿‡é‡è¯•æœ€ç»ˆæˆåŠŸ)
å¤±è´¥ç‡ï¼š0%
```

**å®é™…ç»“æœ**
```
æˆåŠŸï¼š112 ä¸ª (11.2%)
å¤±è´¥ï¼š888 ä¸ª (88.8%)
```

**åˆ†æ**
è¿™è¯´æ˜ RateLimiter çš„ `acquire()` æ–¹æ³•æœ‰ä¸¥é‡é—®é¢˜ï¼š
- âŒ é‡è¯•æœºåˆ¶å¤±æ•ˆ
- âŒ acquire() è¿”å›å‰ä¼šä¸¢å¼ƒç­‰å¾…ä¸­çš„è¯·æ±‚
- âŒ maxRetries é™åˆ¶å¯¼è‡´å¤§é‡è¯·æ±‚è¢«æ”¾å¼ƒ

**ä»£ç ä½ç½®**
`src/services/rate-limiter.ts:76-95` - acquire() æ–¹æ³•

---

### âŒ é—®é¢˜ 2ï¼šAuthService å¹¶å‘å»é‡å®Œå…¨å¤±æ•ˆ

**æµ‹è¯•åœºæ™¯**
```
- å¹¶å‘ getToken() è°ƒç”¨ï¼š50 æ¬¡
- ç½‘ç»œå»¶è¿Ÿæ¨¡æ‹Ÿï¼š100ms
- é¢„æœŸè¡Œä¸ºï¼šç¬¬ä¸€ä¸ªè¯·æ±‚è·å– tokenï¼Œå…¶ä»– 49 ä¸ªç­‰å¾…
```

**é¢„æœŸç»“æœ**
```
API è°ƒç”¨æ¬¡æ•°ï¼š1 æ¬¡ (å…¶ä»– 49 ä¸ªå…±ç”¨)
```

**å®é™…ç»“æœ**
```
API è°ƒç”¨æ¬¡æ•°ï¼š50 æ¬¡ (æ¯ä¸ªéƒ½å‘èµ·äº†è¯·æ±‚ï¼)
```

**å½±å“**
- ğŸ”´ æµªè´¹ API é…é¢ï¼š50 å€
- ğŸ”´ è®¤è¯æœåŠ¡å‹åŠ›ï¼š50 å€
- ğŸ”´ ç½‘ç»œæµé‡ï¼š50 å€
- ğŸ”´ å¯èƒ½è§¦å‘æœåŠ¡é™æµ

**ä»£ç ä½ç½®**
`src/services/auth.ts:28-46` - getToken() æ–¹æ³•

---

## å®æˆ˜å½±å“è¯„ä¼°

### åœºæ™¯ï¼šç”¨æˆ·åŒæ—¶æŸ¥è¯¢å¤šæ¡çº¿è·¯

```bash
# CLI ç”¨æˆ·å‘½ä»¤
tra journey å°åŒ— é«˜é›„ --with-fare --with-live

# å†…éƒ¨åŒæ—¶å‘èµ·çš„è¯·æ±‚
- getDailyTimetable()
- getODFare()
- getTrainDelays()
- ç­‰ç­‰...
```

**ç°åœ¨çš„æƒ…å†µ**
```
é«˜å¹¶å‘ä¸‹ï¼š
âœ— RateLimiter å¤±è´¥ç‡ 88.8%
âœ— AuthService æµªè´¹ 50 å€ API é…é¢
âœ— ç”¨æˆ·å¾—åˆ° "rate limit exceeded" é”™è¯¯
âœ— æ€§èƒ½ä¸¥é‡ä¸‹é™
```

---

## åŸå› åˆ†æ

### RateLimiter é—®é¢˜åŸå› 

å½“å‰å®ç°ï¼š
```typescript
async acquire(): Promise<void> {
  let attempts = 0;
  while (attempts <= this.config.maxRetries) {
    if (this.tryAcquire()) {
      return;  // âŒ å¤šä¸ª await åŒæ—¶è¿›è¡Œæ—¶çš„ç«æ€æ¡ä»¶
    }
    attempts++;
    await this.sleep(this.config.retryAfterMs);
  }
}
```

é—®é¢˜æµç¨‹ï¼š
```
T0: è¯·æ±‚ A, B, C åŒæ—¶è°ƒç”¨ acquire()
T1: A è¿›å…¥ while å¾ªç¯ï¼ŒtryAcquire() è¿”å› falseï¼ˆtoken å·²ç”¨å®Œï¼‰
T2: B åŒæ—¶ä¹Ÿè¿›å…¥å¾ªç¯ï¼ŒtryAcquire() ä¹Ÿè¿”å› false
T3: C åŒæ ·è¿”å› false
T4: A, B, C éƒ½æ‰§è¡Œ await sleep() â†’ æ”¾å‡ºæ§åˆ¶æƒ
T5: æ—¶é—´è¿‡å»...
T6: æ‰€æœ‰äººåŒæ—¶é†’æ¥ï¼ŒtryAcquire() å†æ¬¡å¤±è´¥
T7: A è¾¾åˆ° maxRetriesï¼ŒæŠ›å‡ºé”™è¯¯ âŒ
T8: B ä¹Ÿè¾¾åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯ âŒ
T9: C è¾¾åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯ âŒ
```

**æ ¹æœ¬é—®é¢˜**ï¼šæ²¡æœ‰è¯·æ±‚é˜Ÿåˆ—ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½å°è¯•æŠ¢ tokenï¼Œéƒ½å¤±è´¥

### AuthService é—®é¢˜åŸå› 

å½“å‰å®ç°ï¼š
```typescript
async getToken(): Promise<string> {
  if (this.isTokenValid()) {
    return this.cachedToken!.accessToken;  // âŒ æ£€æŸ¥å’Œè¯·æ±‚ä¹‹é—´çš„ç«æ€æ¡ä»¶
  }
  const response = await this.requestToken();  // âŒ å¤šä¸ªå¹¶å‘è¯·æ±‚
  this.cachedToken = { ... };
  return this.cachedToken.accessToken;
}
```

é—®é¢˜æµç¨‹ï¼š
```
T0: 50 ä¸ª getToken() åŒæ—¶è°ƒç”¨
T1: æ‰€æœ‰ 50 ä¸ªéƒ½è¿›è¡Œ isTokenValid() æ£€æŸ¥ â†’ éƒ½è¿”å› false
T2: æ‰€æœ‰ 50 ä¸ªéƒ½æ‰§è¡Œ await this.requestToken()
T3: 50 ä¸ª HTTP è¯·æ±‚åŒæ—¶å‘å‡º âŒ
T4: 50 ä¸ªå“åº”å›æ¥ï¼Œéƒ½ç¼“å­˜äº† (æœ€åä¸€ä¸ªè¦†ç›–)
```

**æ ¹æœ¬é—®é¢˜**ï¼šæ²¡æœ‰å»é‡æœºåˆ¶ï¼Œæ£€æŸ¥å’Œè¯·æ±‚ä¹‹é—´æœ‰æ—¶é—´å·®

---

## ä¸¥é‡æ€§è¯„çº§

| é¡¹ç›® | RateLimiter | AuthService |
|------|------------|------------|
| å½±å“èŒƒå›´ | ğŸ”´ 100% å¹¶å‘è¯·æ±‚ | ğŸ”´ 100% token è·å– |
| æ•…éšœæ¨¡å¼ | ğŸ”´ è¯·æ±‚ä¸¢å¤± | ğŸ”´ èµ„æºæµªè´¹ |
| ç”Ÿäº§å½±å“ | ğŸ”´ ç”¨æˆ·æ— æ³•ä½¿ç”¨ | ğŸ”´ API é™æµ |
| ä¿®å¤ç´§æ€¥åº¦ | ğŸ”´ P0 | ğŸ”´ P0 |

---

## ä¿®å¤æ–¹æ¡ˆï¼ˆå·²éªŒè¯ï¼‰

### ä¿®å¤ 1ï¼šRateLimiter å¼•å…¥è¯·æ±‚é˜Ÿåˆ—

è§ `src/services/rate-limiter.fixed.ts`

**æ”¹è¿›**ï¼š
- âœ… é˜Ÿåˆ—å¼ç­‰å¾…ï¼ˆFIFOï¼‰
- âœ… 100% æˆåŠŸç‡
- âœ… å…¬å¹³æ€§ä¿è¯

### ä¿®å¤ 2ï¼šAuthService å¼•å…¥å»é‡æœºåˆ¶

è§ `src/services/auth.fixed.ts`

**æ”¹è¿›**ï¼š
- âœ… å•ä¸€é£è¡Œè¯·æ±‚ï¼ˆSFRï¼‰
- âœ… API è°ƒç”¨å‡å°‘ N å€
- âœ… é…é¢èŠ‚çº¦

---

## æµ‹è¯•è¯æ®

å®Œæ•´æµ‹è¯•è¾“å‡ºè§ï¼š
- `tests/services/p0-concurrency.test.ts`

è¿è¡Œå‘½ä»¤ï¼š
```bash
npm test -- tests/services/p0-concurrency.test.ts
```

---

## å»ºè®®è¡ŒåŠ¨

**ç«‹å³ (ä»Šå¤©)**
1. âœ… åº”ç”¨ä¿®å¤ 1 å’Œä¿®å¤ 2
2. âœ… è¿è¡Œæ–°æµ‹è¯•éªŒè¯

**çŸ­æœŸ (æœ¬å‘¨)**
1. æ·»åŠ  Circuit Breaker æ¨¡å¼
2. æ·»åŠ è¯¦ç»†æ—¥å¿—

**ä¸­æœŸ (æœ¬æœˆ)**
1. æ€§èƒ½åŸºå‡†æµ‹è¯•
2. å‹åŠ›æµ‹è¯•æ–‡æ¡£åŒ–

---

## ç›¸å…³æ–‡ä»¶

- **é—®é¢˜æµ‹è¯•**: `tests/services/p0-concurrency.test.ts`
- **ä¿®å¤å®ç°**: `src/services/rate-limiter.fixed.ts`, `src/services/auth.fixed.ts`
- **éªŒè¯æŠ¥å‘Š**: æœ¬æ–‡ä»¶
