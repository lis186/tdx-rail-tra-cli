# Flow Analysis: å¾å–å¾— Access Token åˆ°æ‰“ API

> ç”Ÿæˆæ™‚é–“: 2025-12-28
> åˆ†æç¯„åœ: src/services/

---

## ğŸ”„ åŸ·è¡Œæµç¨‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API è«‹æ±‚åŸ·è¡Œæµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  CLI Command                                                                â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ TDXApiClient    â”‚ api.ts:428                                             â”‚
â”‚  â”‚ request<T>()    â”‚ Entry Point                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ CircuitBreaker  â”‚â”€â”€â”€â”€â–¶â”‚ ç‹€æ…‹æª¢æŸ¥          â”‚                               â”‚
â”‚  â”‚ execute()       â”‚     â”‚ CLOSED/OPEN/     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ HALF_OPEN        â”‚                               â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚ circuit-breaker.ts:58                                           â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ retry()         â”‚â”€â”€â”€â”€â–¶â”‚ æŒ‡æ•¸é€€é¿ + Jitter â”‚                               â”‚
â”‚  â”‚                 â”‚     â”‚ æœ€å¤š 3 æ¬¡é‡è©¦     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚ retry.ts:124                                                    â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ RateLimiter     â”‚â”€â”€â”€â”€â–¶â”‚ Token Bucket     â”‚                               â”‚
â”‚  â”‚ acquire()       â”‚     â”‚ 5 req/s (éŠ…ç´š)    â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚ rate-limiter.ts:81                                              â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ AuthService     â”‚â”€â”€â”€â”€â–¶â”‚ SFR Pattern      â”‚                               â”‚
â”‚  â”‚ getToken()      â”‚     â”‚ é˜²æ­¢é‡è¤‡è«‹æ±‚       â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚ auth.ts:82                                                      â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚           â–¼                                    â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ è¨˜æ†¶é«”å¿«å–       â”‚                  â”‚ ç£ç¢Ÿå¿«å–         â”‚                   â”‚
â”‚  â”‚ (tokenCache)    â”‚                  â”‚ ~/.cache/tdx-traâ”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ /auth/token     â”‚                   â”‚
â”‚           â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚ cache hit?                                                      â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ OAuth2 Token    â”‚                                                        â”‚
â”‚  â”‚ Request         â”‚ POST https://tdx.transportdata.tw/auth/realms/         â”‚
â”‚  â”‚                 â”‚      TDXConnect/protocol/openid-connect/token          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ ofetch()        â”‚ å¯¦éš› HTTP è«‹æ±‚                                          â”‚
â”‚  â”‚                 â”‚ GET/POST https://tdx.transportdata.tw/api/basic/...    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ è©³ç´°ç¯€é»èªªæ˜

### 1. TDXApiClient.request() - å…¥å£é»

**æª”æ¡ˆ**: `src/services/api.ts:428`

```typescript
private async request<T>(
  endpoint: string,
  options: RequestOptions = {}
): Promise<T> {
  // ä½¿ç”¨ Circuit Breaker åŒ…è£è«‹æ±‚
  return this.circuitBreaker.execute(async () => {
    // ä½¿ç”¨ retry åŒ…è£å¯¦éš›è«‹æ±‚
    return retry(
      async () => {
        // å–å¾— Rate Limit token
        await rateLimiter.acquire();

        // å–å¾— Auth token
        const token = await this.authService.getToken();

        // ç™¼é€è«‹æ±‚
        return ofetch<T>(url, {
          headers: { Authorization: `Bearer ${token}` },
          ...
        });
      },
      retryConfig
    );
  });
}
```

**è·è²¬**:
- çµ±ä¸€ API è«‹æ±‚å…¥å£
- çµ„åˆæ‰€æœ‰ä¿è­·å±¤ï¼ˆCircuit Breaker â†’ Retry â†’ Rate Limit â†’ Authï¼‰
- è™•ç†éŸ¿æ‡‰å’ŒéŒ¯èª¤

---

### 2. CircuitBreaker.execute() - ç†”æ–·å™¨

**æª”æ¡ˆ**: `src/services/circuit-breaker.ts:58`

```typescript
async execute<T>(fn: () => Promise<T>): Promise<T> {
  // æª¢æŸ¥ç†”æ–·å™¨ç‹€æ…‹
  if (this.state === CircuitState.OPEN) {
    if (Date.now() < this.nextAttempt) {
      throw new CircuitBreakerError('Circuit is OPEN');
    }
    this.state = CircuitState.HALF_OPEN;
  }

  try {
    const result = await fn();
    this.onSuccess();
    return result;
  } catch (error) {
    this.onFailure();
    throw error;
  }
}
```

**ç‹€æ…‹è½‰æ›**:
```
         æˆåŠŸ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”  å¤±æ•—é”é–¾å€¼  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚CLOSED â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ OPEN â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”¬â”€â”€â”€â”˜
    â–²                     â”‚
    â”‚     è¶…æ™‚å¾Œå˜—è©¦       â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â””â”€â”€â”€â”€â”‚HALF_OPEN â”‚â—€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®**:
- `failureThreshold`: 5 æ¬¡å¤±æ•—å¾Œé–‹å•Ÿ
- `resetTimeout`: 30 ç§’å¾Œå˜—è©¦åŠé–‹
- `successThreshold`: 2 æ¬¡æˆåŠŸå¾Œé—œé–‰

---

### 3. retry() - é‡è©¦æ©Ÿåˆ¶

**æª”æ¡ˆ**: `src/services/retry.ts:124`

```typescript
async function retry<T>(
  fn: () => Promise<T>,
  config: RetryConfig
): Promise<T> {
  let lastError: Error;

  for (let attempt = 0; attempt <= config.maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;

      if (!isRetryableError(error)) {
        throw error;
      }

      // è¨ˆç®—é€€é¿æ™‚é–“ï¼ˆæŒ‡æ•¸ + jitterï¼‰
      const delay = calculateBackoff(attempt, config);
      await sleep(delay);
    }
  }

  throw lastError;
}
```

**å¯é‡è©¦éŒ¯èª¤ç¢¼**:
- `408` - Request Timeout
- `429` - Too Many Requests
- `500` - Internal Server Error
- `502` - Bad Gateway
- `503` - Service Unavailable
- `504` - Gateway Timeout

**é€€é¿ç­–ç•¥**:
```
delay = min(
  baseDelay * (2 ^ attempt) + random(0, jitter),
  maxDelay
)
```

---

### 4. RateLimiter.acquire() - é™æµå™¨

**æª”æ¡ˆ**: `src/services/rate-limiter.ts:81`

```typescript
async acquire(): Promise<void> {
  // å…ˆå˜—è©¦ç«‹å³ç²å–
  if (this.tryAcquire()) {
    return;
  }

  // è¨ˆç®—æœ€å¤§ç­‰å¾…æ™‚é–“
  const maxWaitRequests = Math.ceil(this.config.maxTokens * 10);
  const totalWaitMs = (maxWaitRequests / this.config.refillRate) * 1000;
  const maxRetries = Math.ceil(totalWaitMs / this.config.retryAfterMs);

  let attempts = 0;
  while (attempts < maxRetries) {
    await this.sleep(this.config.retryAfterMs);
    attempts++;
    if (this.tryAcquire()) {
      return;
    }
  }

  throw new RateLimitError('API è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦', this.config.retryAfterMs);
}
```

**Token Bucket æ¼”ç®—æ³•**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Token Bucket               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â—‹ â—‹ â—‹ â—‹ â—‹  (maxTokens: 5)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  è£œå……é€Ÿç‡: 5 tokens/ç§’ (éŠ…ç´šæœƒå“¡)    â”‚
â”‚  ç­‰å¾…é–“éš”: 200ms                    â”‚
â”‚  æœ€å¤§é‡è©¦: å‹•æ…‹è¨ˆç®—                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. AuthService.getToken() - èªè­‰æœå‹™

**æª”æ¡ˆ**: `src/services/auth.ts:82`

```typescript
async getToken(): Promise<string> {
  // Single Flight Request (SFR) æ¨¡å¼
  // é˜²æ­¢ä¸¦ç™¼æ™‚é‡è¤‡è«‹æ±‚ token
  if (this.inFlightTokenPromise) {
    return this.inFlightTokenPromise;
  }

  // æª¢æŸ¥è¨˜æ†¶é«”å¿«å–
  if (this.tokenCache && !this.isTokenExpired()) {
    return this.tokenCache.access_token;
  }

  // æª¢æŸ¥ç£ç¢Ÿå¿«å–
  const diskToken = await this.loadTokenFromDisk();
  if (diskToken && !this.isTokenExpiredWithBuffer(diskToken)) {
    this.tokenCache = diskToken;
    return diskToken.access_token;
  }

  // è«‹æ±‚æ–° token
  this.inFlightTokenPromise = this.requestNewToken();
  try {
    const token = await this.inFlightTokenPromise;
    return token;
  } finally {
    this.inFlightTokenPromise = null;
  }
}
```

**SFR æ¨¡å¼èªªæ˜**:
```
ä¸¦ç™¼è«‹æ±‚ 1 â”€â”€â”
ä¸¦ç™¼è«‹æ±‚ 2 â”€â”€â”¼â”€â”€â–¶ å–®ä¸€ OAuth2 è«‹æ±‚ â”€â”€â–¶ å…±äº« Token
ä¸¦ç™¼è«‹æ±‚ 3 â”€â”€â”˜
```

**å¿«å–å±¤ç´š**:
1. **è¨˜æ†¶é«”å¿«å–** (`tokenCache`) - åŒé€²ç¨‹å…§å…±äº«
2. **ç£ç¢Ÿå¿«å–** (`~/.cache/tdx-tra/auth/token`) - è·¨é€²ç¨‹å…±äº«ï¼Œ24h TTL
3. **æå‰åˆ·æ–°** - éæœŸå‰ 60 ç§’è‡ªå‹•åˆ·æ–°

---

## ğŸ” OAuth2 Token è«‹æ±‚

**ç«¯é»**: `POST https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token`

**è«‹æ±‚æ ¼å¼**:
```
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id={TDX_CLIENT_ID}
&client_secret={TDX_CLIENT_SECRET}
```

**éŸ¿æ‡‰æ ¼å¼**:
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "expires_in": 86400,
  "token_type": "Bearer"
}
```

---

## ğŸ“Š éŒ¯èª¤è™•ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       éŒ¯èª¤åˆ†é¡èˆ‡è™•ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  HTTP Error                                                     â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ˜¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ å¯é‡è©¦éŒ¯èª¤ï¼Ÿ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ retry()     â”‚                       â”‚
â”‚  â”‚ 408,429,5xx â”‚          â”‚ æŒ‡æ•¸é€€é¿é‡è©¦  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚ å¦                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ˜¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ èªè­‰éŒ¯èª¤ï¼Ÿ   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ æ¸…é™¤ token   â”‚                       â”‚
â”‚  â”‚ 401, 403   â”‚          â”‚ é‡æ–°èªè­‰      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚ å¦                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ å‘ä¸Šæ‹‹å‡º     â”‚ ç”± Circuit Breaker è¨˜éŒ„å¤±æ•—                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ç›¸é—œæª”æ¡ˆç´¢å¼•

| æª”æ¡ˆ | è¡Œæ•¸ | ä¸»è¦è·è²¬ |
|------|------|---------|
| `src/services/api.ts` | 587 | TDX API å®¢æˆ¶ç«¯ï¼Œçµ±ä¸€è«‹æ±‚å…¥å£ |
| `src/services/auth.ts` | 209 | OAuth2 èªè­‰ï¼ŒToken ç®¡ç† |
| `src/services/rate-limiter.ts` | 173 | Token Bucket é™æµ (5 req/s) |
| `src/services/circuit-breaker.ts` | 127 | ç†”æ–·å™¨æ¨¡å¼ |
| `src/services/retry.ts` | 189 | æŒ‡æ•¸é€€é¿é‡è©¦ |
| `src/services/cache.ts` | 280 | æª”æ¡ˆå¿«å–æœå‹™ |

---

## ğŸ¯ é—œéµè¨­è¨ˆæ±ºç­–

1. **é˜²ç¦¦æ€§è¨­è¨ˆ**: å¤šå±¤ä¿è­·ç¢ºä¿ API ç©©å®šæ€§
   - Circuit Breaker é˜²æ­¢é›ªå´©
   - Rate Limiter éµå®ˆ API é™åˆ¶
   - Retry è™•ç†æš«æ™‚æ€§éŒ¯èª¤

2. **æ•ˆèƒ½å„ªåŒ–**:
   - SFR æ¨¡å¼é¿å…é‡è¤‡ Token è«‹æ±‚
   - å¤šå±¤å¿«å–æ¸›å°‘ç¶²è·¯è«‹æ±‚
   - Token ç£ç¢ŸæŒä¹…åŒ–ï¼ˆè·¨é€²ç¨‹å…±äº«ï¼‰

3. **éŠ…ç´šæœƒå“¡é™åˆ¶**:
   - 5 req/s per API Key
   - Token Bucket æ¼”ç®—æ³•ç¢ºä¿ä¸è¶…é™
   - å‹•æ…‹ç­‰å¾…é¿å…è«‹æ±‚å¤±æ•—
